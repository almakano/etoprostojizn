<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
        }
        .header {
            background-color: #1f1f1f;
            padding: 1rem;
            border-bottom: 1px solid #333;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <header class="header d-flex justify-content-between align-items-center">
        <div class="logo">
            <a href="/" class="text-white text-decoration-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-house-door-fill" viewBox="0 0 16 16">
                    <path d="M6.5 14.5v-3.5h3v3.5h-3z"/>
                    <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7.293l-6-6-6 6V1zm11 8.293V15a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-5.293l6-6 6 6z"/>
                </svg>
                Dashboard
            </a>
        </div>
        <div>
            <button class="btn btn-info" id="import-btn">Import IG</button>
            <a href="/dashboard/settings" class="btn btn-secondary">Settings</a>
            <a href="/dashboard/orders" class="btn btn-secondary">Orders</a>
            <button class="btn btn-primary" id="upload-btn">Upload</button>
        </div>
    </header>

    <main class="container-fluid mt-4">
        <div class="row" id="pictures-grid">
            <!-- Pictures will be loaded here -->
        </div>
    </main>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-original-name">
                        <div class="mb-3">
                            <label for="edit-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="edit-price" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-image-file" class="form-label">Image from file</label>
                            <input type="file" class="form-control" id="edit-image-file" multiple>
                        </div>
                        <div class="mb-3">
                            <label for="edit-image" class="form-label">Image from URL</label>
                            <input type="text" class="form-control" id="edit-image">
                        </div>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div class="modal fade" id="sellModal" tabindex="-1" aria-labelledby="sellModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="sellModalLabel">Sell Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="sell-form">
                        <input type="hidden" id="sell-picture-name">
                        <div class="mb-3">
                            <label for="sell-customer" class="form-label">Customer</label>
                            <input type="text" class="form-control" id="sell-customer" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="sell-price" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="sell-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Sell</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function() {
            if (!localStorage.getItem('github-pass')) {
                window.location.href = '/login.html';
            }

            let mainData;

            $.getJSON(`../data.json?t=${new Date().getTime()}`, function(data) {
                mainData = data;
                renderPictures(mainData.pictures);
            });

            function renderPictures(pictures) {
                const picturesGrid = $('#pictures-grid');
                picturesGrid.empty();
                pictures.forEach(pic => {
                    const pictureCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card bg-dark text-white position-relative">
                                <img src="${pic.image}" class="card-img-top" alt="${pic.name}" crossorigin="anonymous">
                                <div class="card-body">
                                    <h5 class="card-title">${pic.name}</h5>
                                    <p class="card-text">${pic.description}</p>
                                </div>
                                <div class="position-absolute top-0 end-0 p-2">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton">
                                            <li><a class="dropdown-item delete-btn" href="#" data-name="${pic.name}">Delete</a></li>
                                            <li><a class="dropdown-item edit-btn" href="#" data-name="${pic.name}">Edit</a></li>
                                            <li><a class="dropdown-item sell-btn" href="#" data-name="${pic.name}">Sell to</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    picturesGrid.append(pictureCard);
                });
            }

            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                const pictureName = $(this).data('name');
                if (confirm(`Are you sure you want to delete "${pictureName}"?`)) {
                    mainData.pictures = mainData.pictures.filter(p => p.name !== pictureName);
                    updateDataFile(mainData);
                }
            });

            $(document).on('click', '.edit-btn', function(e) {
                e.preventDefault();
                const pictureName = $(this).data('name');
                const picture = mainData.pictures.find(p => p.name === pictureName);
                $('#edit-original-name').val(picture.name);
                $('#edit-name').val(picture.name);
                $('#edit-description').val(picture.description);
                $('#edit-price').val(picture.price);
                $('#edit-image').val(picture.image);
                $('#editModal').modal('show');
            });

            $('#edit-form').on('submit', function(e) {
                e.preventDefault();
                const originalName = $('#edit-original-name').val();
                const imageFiles = $('#edit-image-file')[0].files;

                if (imageFiles.length > 0) {
                    const uploadPromises = [];
                    for (const imageFile of imageFiles) {
                        const reader = new FileReader();
                        const promise = new Promise((resolve, reject) => {
                            reader.onload = function(e) {
                                const content = e.target.result.split(',')[1];
                                resolve({ name: imageFile.name, content: content });
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(imageFile);
                        });
                        uploadPromises.push(promise);
                    }

                    Promise.all(uploadPromises)
                        .then(files => {
                            const uploadFilePromises = files.map(file => uploadFile(file.name, file.content));
                            return Promise.all(uploadFilePromises);
                        })
                        .then(responses => {
                            const imageUrls = responses.map(response => `/upload/${response.content.name}`);
                            if (originalName) {
                                savePicture(originalName, imageUrls[0]);
                            } else {
                                imageUrls.forEach((imageUrl, index) => {
                                    const newPicture = {
                                        name: `Artwork ${mainData.pictures.length + index + 1}`,
                                        description: '',
                                        price: 0,
                                        image: imageUrl,
                                        createdAt: new Date().toISOString()
                                    };
                                    mainData.pictures.unshift(newPicture);
                                });
                                updateDataFile(mainData);
                                $('#editModal').modal('hide');
                            }
                        })
                        .catch(() => alert('Error uploading images!'));
                } else {
                    savePicture(originalName, $('#edit-image').val());
                }
            });

            function savePicture(originalName, imageUrl) {
                const updatedPicture = {
                    name: $('#edit-name').val(),
                    description: $('#edit-description').val(),
                    price: parseInt($('#edit-price').val(), 10),
                    image: imageUrl,
                    createdAt: originalName ? mainData.pictures.find(p => p.name === originalName).createdAt : new Date().toISOString()
                };

                if (originalName) {
                    const pictureIndex = mainData.pictures.findIndex(p => p.name === originalName);
                    mainData.pictures[pictureIndex] = updatedPicture;
                } else {
                    mainData.pictures.unshift(updatedPicture);
                }

                updateDataFile(mainData);
                $('#editModal').modal('hide');
            }

            $('#upload-btn').on('click', function() {
                $('#edit-original-name').val('');
                $('#edit-name').val('');
                $('#edit-description').val('');
                $('#edit-price').val('');
                $('#edit-image').val('');
                $('#editModalLabel').text('Upload Picture');
                $('#editModal').modal('show');
            });

            $('#import-btn').on('click', function() {
                let token = localStorage.getItem('apify-pass');
                if (!token) {
                    token = prompt('Please enter your Apify token:');
                    if (token) {
                        localStorage.setItem('apify-pass', token);
                    } else {
                        alert('Apify token is required for import.');
                        return;
                    }
                }

                const url = "https://api.apify.com/v2/acts/apify~instagram-profile-scraper/run-sync-get-dataset-items";
                const data = {
                    "usernames": ["tkach2t"],
                    "resultsLimit": 1000,
                    "proxyConfiguration": {
                        "useApifyProxy": true
                    }
                };

                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify(data),
                    success: function(data) {
                        mainData.timestamp = new Date().toISOString();
                        if (data && data.length > 0 && data[0].latestPosts) {
                            const existingImages = new Set(mainData.pictures.map(p => p.image));
                            const newPictures = data[0].latestPosts
                                .filter(item => !existingImages.has(item.displayUrl))
                                .map(item => ({
                                    name: item.caption ? item.caption.split('\n')[0] : `Artwork ${mainData.pictures.length + 1}`,
                                    description: item.caption || '',
                                    price: 0,
                                    image: item.displayUrl,
                                    createdAt: new Date(item.timestamp).toISOString(),
                                    timestamp: new Date().toISOString()
                                }));

                            if (newPictures.length > 0) {
                                mainData.pictures.unshift(...newPictures);
                                updateDataFile(mainData);
                            } else {
                                alert('No new pictures found.');
                            }
                        } else {
                            alert('No new pictures found.');
                        }
                    },
                    error: function() {
                        alert('Error importing from Instagram!');
                    }
                });
            });

            $(document).on('click', '.sell-btn', function(e) {
                e.preventDefault();
                const pictureName = $(this).data('name');
                $('#sell-picture-name').val(pictureName);
                $('#sellModal').modal('show');
            });

            $('#sell-form').on('submit', function(e) {
                e.preventDefault();
                const pictureName = $('#sell-picture-name').val();
                const picture = mainData.pictures.find(p => p.name === pictureName);
                const order = {
                    picture: pictureName,
                    customer: $('#sell-customer').val(),
                    price: parseInt($('#sell-price').val(), 10),
                    date: $('#sell-date').val(),
                    soldAt: new Date().toISOString()
                };
                if (!mainData.orders) {
                    mainData.orders = [];
                }
                mainData.orders.push(order);
                mainData.pictures = mainData.pictures.filter(p => p.name !== pictureName);
                updateDataFile(mainData);
                $('#sellModal').modal('hide');
            });

            function updateDataFile(data) {
                const token = localStorage.getItem('github-pass');
                const repo = 'almakano/etoprostojizn';
                const path = 'data.json';
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: {
                        'Authorization': `token ${token}`
                    }
                }).done(function(response) {
                    $.ajax({
                        url: url,
                        type: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`
                        },
                        data: JSON.stringify({
                            message: `Update data.json`,
                            content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 4)))),
                            sha: response.sha
                        }),
                        success: function() {
                            alert('Data updated successfully!');
                            renderPictures(mainData.pictures);
                        },
                        error: function() {
                            alert('Error updating data!');
                        }
                    });
                });
            }

            function uploadFile(name, content) {
                const token = localStorage.getItem('github-pass');
                const repo = 'almakano/etoprostojizn';
                const path = `upload/${name}`;
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                return $.ajax({
                    url: url,
                    type: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`
                    },
                    data: JSON.stringify({
                        message: `Upload ${name}`,
                        content: content
                    })
                });
            }
        });
    </script>
</body>
</html>
