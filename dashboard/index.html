<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/dashboard/css/template.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebar" class="col-md-2 d-md-block sidebar offcanvas-md offcanvas-start">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/dashboard">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bar-chart-2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/orders">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                                Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/settings">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                                Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="import-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Import IG
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="upload-btn">Upload</button>
                        <div class="theme-toggler ms-3">ðŸŒ™</div>
                    </div>
                </div>

                <div class="row" id="pictures-grid">
                    <!-- Pictures will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-original-name">
                        <div class="mb-3">
                            <label for="edit-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="edit-price" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-image-file" class="form-label">Image from file</label>
                            <input type="file" class="form-control" id="edit-image-file" multiple>
                        </div>
                        <div class="mb-3">
                            <label for="edit-image" class="form-label">Image from URL</label>
                            <input type="text" class="form-control" id="edit-image">
                        </div>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sell Modal -->
    <div class="modal fade" id="sellModal" tabindex="-1" aria-labelledby="sellModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sellModalLabel">Sell Picture</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="sell-form">
                        <input type="hidden" id="sell-picture-name">
                        <div class="mb-3">
                            <label for="sell-customer" class="form-label">Customer</label>
                            <input type="text" class="form-control" id="sell-customer" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell-price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="sell-price" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="sell-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Sell</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function() {
            let touchstartX = 0;
            let touchendX = 0;

            const sidebar = document.getElementById('sidebar');
            const sidebarOffcanvas = new bootstrap.Offcanvas(sidebar);

            function handleGesture() {
                if (touchendX < touchstartX && touchstartX - touchendX > 50) {
                    sidebarOffcanvas.hide();
                }
                if (touchendX > touchstartX && touchendX - touchstartX > 50) {
                    sidebarOffcanvas.show();
                }
            }

            document.addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
            });

            document.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                handleGesture();
            });
            // Theme switcher
            function applyTheme(theme) {
                if (theme === 'dark') {
                    $('body').addClass('dark-mode');
                    $('.theme-toggler').text('ðŸŒ™');
                } else {
                    $('body').removeClass('dark-mode');
                    $('.theme-toggler').text('â˜€ï¸');
                }
            }

            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            $('.theme-toggler').on('click', function() {
                const currentTheme = $('body').hasClass('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            if (!localStorage.getItem('github-pass')) {
                window.location.href = '/login.html';
            }

            let mainData;

            $.getJSON(`../data.json?t=${new Date().getTime()}`, function(data) {
                mainData = data;
                renderPictures(mainData.pictures);
            });

            function renderPictures(pictures) {
                const picturesGrid = $('#pictures-grid');
                picturesGrid.empty();
                pictures.forEach((pic, index) => {
                    let pictureHtml;
                    if (pic.childPosts && pic.childPosts.length > 0) {
                        const carouselId = `carousel-${index}`;
                        let carouselItems = `<div class="carousel-item active"><img src="${pic.image}" class="d-block w-100" alt="${pic.alt || pic.name}"></div>`;
                        pic.childPosts.forEach(child => {
                            carouselItems += `<div class="carousel-item"><img src="${child.displayUrl}" class="d-block w-100" alt="${child.alt || pic.name}"></div>`;
                        });

                        pictureHtml = `
                            <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    ${carouselItems}
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        `;
                    } else {
                        pictureHtml = `<img src="${pic.image}" class="card-img-top" alt="${pic.alt || pic.name}" crossorigin="anonymous">`;
                    }

                    const pictureCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card position-relative">
                                ${pictureHtml}
                                <div class="card-body">
                                    <h5 class="card-title">${pic.name}</h5>
                                    <p class="card-text">${pic.description}</p>
                                </div>
                                <div class="position-absolute top-0 end-0 p-2">
                                    <div class="dropdown">
                                        <button class="btn btn-secondary btn-sm" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                                                <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            </svg>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="dropdownMenuButton">
                                            <li><a class="dropdown-item edit-btn" href="#" data-name="${pic.name}">Edit</a></li>
                                            <li><a class="dropdown-item delete-btn bg-danger" href="#" data-name="${pic.name}">Delete</a></li>
                                            <li><a class="dropdown-item sell-btn" href="#" data-name="${pic.name}">Sell to</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    picturesGrid.append(pictureCard);
                });
            }

            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                const pictureName = $(this).data('name');
                if (confirm(`Are you sure you want to delete "${pictureName}"?`)) {
                    mainData.pictures = mainData.pictures.filter(p => p.name !== pictureName);
                    updateDataFile(mainData);
                }
            });

            $(document).on('click', '.edit-btn', function(e) {
                e.preventDefault();
                const pictureName = $(this).data('name');
                const picture = mainData.pictures.find(p => p.name === pictureName);
                $('#edit-original-name').val(picture.name);
                $('#edit-name').val(picture.name);
                $('#edit-description').val(picture.description);
                $('#edit-price').val(picture.price);
                $('#edit-image').val(picture.image);
                $('#editModal').modal('show');
            });

            $('#edit-form').on('submit', function(e) {
                e.preventDefault();
                const originalName = $('#edit-original-name').val();
                const imageFiles = $('#edit-image-file')[0].files;

                if (imageFiles.length > 0) {
                    const uploadPromises = [];
                    for (const imageFile of imageFiles) {
                        const reader = new FileReader();
                        const promise = new Promise((resolve, reject) => {
                            reader.onload = function(e) {
                                const content = e.target.result.split(',')[1];
                                resolve({ name: imageFile.name, content: content });
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(imageFile);
                        });
                        uploadPromises.push(promise);
                    }

                    Promise.all(uploadPromises)
                        .then(files => {
                            const uploadFilePromises = files.map(file => uploadFile(file.name, file.content));
                            return Promise.all(uploadFilePromises);
                        })
                        .then(responses => {
                            const imageUrls = responses.map(response => `/upload/${response.content.name}`);
                            if (originalName) {
                                savePicture(originalName, imageUrls[0]);
                            } else {
                                imageUrls.forEach((imageUrl, index) => {
                                    const newPicture = {
                                        name: `Artwork ${mainData.pictures.length + index + 1}`,
                                        description: '',
                                        price: 0,
                                        image: imageUrl,
                                        createdAt: new Date().toISOString()
                                    };
                                    mainData.pictures.unshift(newPicture);
                                });
                                updateDataFile(mainData);
                                $('#editModal').modal('hide');
                            }
                        })
                        .catch(() => alert('Error uploading images!'));
                } else {
                    savePicture(originalName, $('#edit-image').val());
                }
            });

            function savePicture(originalName, imageUrl) {
                const updatedPicture = {
                    name: $('#edit-name').val(),
                    description: $('#edit-description').val(),
                    price: parseInt($('#edit-price').val(), 10),
                    image: imageUrl,
                    createdAt: originalName ? mainData.pictures.find(p => p.name === originalName).createdAt : new Date().toISOString()
                };

                if (originalName) {
                    const pictureIndex = mainData.pictures.findIndex(p => p.name === originalName);
                    mainData.pictures[pictureIndex] = updatedPicture;
                } else {
                    mainData.pictures.unshift(updatedPicture);
                }

                updateDataFile(mainData);
                $('#editModal').modal('hide');
            }

            $('#upload-btn').on('click', function() {
                $('#edit-original-name').val('');
                $('#edit-name').val('');
                $('#edit-description').val('');
                $('#edit-price').val('');
                $('#edit-image').val('');
                $('#editModalLabel').text('Upload Picture');
                $('#editModal').modal('show');
            });

            $('#import-btn').on('click', function() {
                const importBtn = $(this);
                const spinner = importBtn.find('.spinner-border');

                let token = localStorage.getItem('apify-pass');
                if (!token) {
                    token = prompt('Please enter your Apify token:');
                    if (token) {
                        localStorage.setItem('apify-pass', token);
                    } else {
                        alert('Apify token is required for import.');
                        return;
                    }
                }

                importBtn.prop('disabled', true);
                spinner.removeClass('d-none');

                const url = "https://api.apify.com/v2/acts/apify~instagram-profile-scraper/run-sync-get-dataset-items";
                const data = {
                    "usernames": ["tkach2t"],
                    "resultsLimit": 1000,
                    "proxyConfiguration": {
                        "useApifyProxy": true
                    }
                };

                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify(data),
                    success: function(data) {
                        mainData.timestamp = new Date().toISOString();
                        if (data && data.length > 0 && data[0].latestPosts) {
                            const existingImages = new Set(mainData.pictures.map(p => p.image));
                            const newPictures = data[0].latestPosts
                                .filter(item => !existingImages.has(item.displayUrl))
                                .map(item => ({
                                    name: item.caption ? item.caption.split('\n')[0] : `Artwork ${mainData.pictures.length + 1}`,
                                    description: item.caption || '',
                                    price: 0,
                                    image: item.displayUrl,
                                    createdAt: new Date(item.timestamp).toISOString(),
                                    timestamp: new Date().toISOString(),
                                    childPosts: item.childPosts || []
                                }));

                            if (newPictures.length > 0) {
                                mainData.pictures.unshift(...newPictures);
                                updateDataFile(mainData);
                            } else {
                                alert('No new pictures found.');
                            }
                        } else {
                            alert('No new pictures found.');
                        }
                    },
                    error: function() {
                        alert('Error importing from Instagram!');
                    },
                    complete: function() {
                        importBtn.prop('disabled', false);
                        spinner.addClass('d-none');
                    }
                });
            });

            $(document).on('click', '.sell-btn', function(e) {
                e.preventDefault();
                const pictureName = $(this).data('name');
                $('#sell-picture-name').val(pictureName);
                $('#sellModal').modal('show');
            });

            $('#sell-form').on('submit', function(e) {
                e.preventDefault();
                const pictureName = $('#sell-picture-name').val();
                const picture = mainData.pictures.find(p => p.name === pictureName);
                const order = {
                    picture: pictureName,
                    customer: $('#sell-customer').val(),
                    price: parseInt($('#sell-price').val(), 10),
                    date: $('#sell-date').val(),
                    soldAt: new Date().toISOString()
                };
                if (!mainData.orders) {
                    mainData.orders = [];
                }
                mainData.orders.push(order);
                mainData.pictures = mainData.pictures.filter(p => p.name !== pictureName);
                updateDataFile(mainData);
                $('#sellModal').modal('hide');
            });

            function updateDataFile(data) {
                const token = localStorage.getItem('github-pass');
                const repo = 'almakano/etoprostojizn';
                const path = 'data.json';
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: {
                        'Authorization': `token ${token}`
                    }
                }).done(function(response) {
                    $.ajax({
                        url: url,
                        type: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`
                        },
                        data: JSON.stringify({
                            message: `Update data.json`,
                            content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 4)))),
                            sha: response.sha
                        }),
                        success: function() {
                            alert('Data updated successfully!');
                            renderPictures(mainData.pictures);
                        },
                        error: function() {
                            alert('Error updating data!');
                        }
                    });
                });
            }

            function uploadFile(name, content) {
                const token = localStorage.getItem('github-pass');
                const repo = 'almakano/etoprostojizn';
                const path = `upload/${name}`;
                const url = `https://api.github.com/repos/${repo}/contents/${path}`;

                return $.ajax({
                    url: url,
                    type: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`
                    },
                    data: JSON.stringify({
                        message: `Upload ${name}`,
                        content: content
                    })
                });
            }
        });
    </script>
</body>
</html>
